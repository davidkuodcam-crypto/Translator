<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS èªéŸ³å¼•æ“å¤§å°æ±º</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --surface: #ffffff; --text: #1e293b; }
        body { font-family: system-ui, sans-serif; background-color: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 2rem 1rem; line-height: 1.5; }
        .container { background: var(--surface); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        h1 { margin-top: 0; text-align: center; color: var(--primary); }
        .control-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        select, textarea { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        textarea { height: 120px; resize: vertical; }
        .radio-group { display: flex; gap: 1rem; background: #f1f5f9; padding: 0.5rem; border-radius: 8px; }
        .radio-option { flex: 1; text-align: center; }
        .radio-option input { display: none; }
        .radio-option label { cursor: pointer; padding: 0.5rem; border-radius: 6px; display: block; transition: all 0.2s; }
        .radio-option input:checked + label { background: var(--primary); color: white; font-weight: bold; }
        button { width: 100%; background-color: var(--primary); color: white; border: none; padding: 1rem; font-size: 1.1rem; border-radius: 8px; cursor: pointer; }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; }
        #status { margin-top: 1rem; text-align: center; font-size: 0.9rem; color: #ef4444; white-space: pre-wrap; word-break: break-all; }
        .note { font-size: 0.8rem; color: #ef4444; margin-top: 0.5rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”Š TTS èªéŸ³å¼•æ“å°æ±º (è¨ºæ–·ç‰ˆ)</h1>
    
    <div class="control-group">
        <label>1. é¸æ“‡èªè¨€</label>
        <select id="langSelect">
            <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ (å°ç£)</option>
            <option value="en">ğŸ‡ºğŸ‡¸ è‹±æ–‡ (English)</option>
            <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æ–‡ (æ—¥æœ¬èª)</option>
            <option value="vi">ğŸ‡»ğŸ‡³ è¶Šå—èª (Tiáº¿ng Viá»‡t)</option>
        </select>
    </div>

    <div class="control-group">
        <label>2. é¸æ“‡ç™¼éŸ³å¼•æ“</label>
        <div class="radio-group">
            <div class="radio-option">
                <input type="radio" id="engine-browser" name="engine" value="browser" checked>
                <label for="engine-browser">ç€è¦½å™¨å…§å»º<br><small>(å¿«)</small></label>
            </div>
            <div class="radio-option">
                <input type="radio" id="engine-server" name="engine" value="server">
                <label for="engine-server">Google gTTS<br><small>(æ…¢/API)</small></label>
            </div>
        </div>
        <div id="browser-warning" class="note" style="display:none">âš ï¸ æ³¨æ„ï¼šæ‚¨çš„é›»è…¦å¯èƒ½ä¸æ”¯æ´æ­¤èªè¨€ã€‚</div>
    </div>

    <div class="control-group">
        <label>3. è¼¸å…¥æ–‡å­—</label>
        <textarea id="textInput">ä½ å¥½ï¼Œä»Šå¤©å¤©æ°£çœŸä¸éŒ¯ã€‚</textarea>
    </div>

    <button id="speakBtn" onclick="handleSpeak()">é–‹å§‹æœ—è®€</button>
    <div id="status"></div>
    <audio id="audioPlayer" style="display:none"></audio>
</div>

<script>
    const synth = window.speechSynthesis;
    const statusDiv = document.getElementById('status');
    const speakBtn = document.getElementById('speakBtn');
    const langSelect = document.getElementById('langSelect');
    const warning = document.getElementById('browser-warning');

    const defaultTexts = {
        'zh-TW': 'ä½ å¥½ï¼Œä»Šå¤©å¤©æ°£çœŸä¸éŒ¯ã€‚', 'en': 'Hello, the weather is nice today.',
        'ja': 'ã“ã‚“ã«ã¡ã¯ã€ã„ã„å¤©æ°—ã§ã™ã­ã€‚', 'vi': 'Xin chÃ o, hÃ´m nay thá»i tiáº¿t Ä‘áº¹p.'
    };

    langSelect.addEventListener('change', (e) => {
        document.getElementById('textInput').value = defaultTexts[e.target.value];
        warning.style.display = (e.target.value === 'vi') ? 'block' : 'none';
    });

    async function handleSpeak() {
        const text = document.getElementById('textInput').value;
        const lang = langSelect.value;
        const engine = document.querySelector('input[name="engine"]:checked').value;

        if (!text) return alert("è«‹è¼¸å…¥æ–‡å­—");

        speakBtn.disabled = true;
        statusDiv.innerText = "è™•ç†ä¸­...";
        statusDiv.style.color = "#64748b";

        if (engine === 'browser') {
            speakWithBrowser(text, lang);
        } else {
            await speakWithServer(text, lang);
        }
    }

    function speakWithBrowser(text, lang) {
        synth.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = (lang === 'en') ? 'en-US' : (lang === 'ja' ? 'ja-JP' : (lang === 'vi' ? 'vi-VN' : lang));
        utterance.onend = () => { statusDiv.innerText = "âœ… æœ—è®€çµæŸ"; speakBtn.disabled = false; };
        utterance.onerror = (e) => { console.error(e); statusDiv.innerText = "âŒ ç€è¦½å™¨éŒ¯èª¤"; speakBtn.disabled = false; };
        synth.speak(utterance);
    }

    // --- é—œéµä¿®æ”¹ï¼šé¡¯ç¤ºè©³ç´°éŒ¯èª¤ ---
    async function speakWithServer(text, lang) {
        statusDiv.innerText = "â³ å‘¼å« Vercel API...";
        const player = document.getElementById('audioPlayer');

        try {
            const response = await fetch(`/api/speak?text=${encodeURIComponent(text)}&lang=${lang}`);
            
            // å¦‚æœå¤±æ•— (ä¾‹å¦‚ 500 æˆ– 404)ï¼Œè®€å–ä¼ºæœå™¨å›å‚³çš„æ–‡å­—
            if (!response.ok) {
                const errorText = await response.text(); 
                // åˆ¤æ–·æ˜¯å¦ç‚º 404 é é¢ HTML
                if (errorText.includes("<!DOCTYPE html>")) {
                    throw new Error(`è·¯å¾‘éŒ¯èª¤ (${response.status}) - API è·¯å¾‘æ‰¾ä¸åˆ°`);
                } else {
                    throw new Error(`API éŒ¯èª¤ (${response.status}): ${errorText}`);
                }
            }

            const blob = await response.blob();
            player.src = URL.createObjectURL(blob);
            player.style.display = 'block';
            await player.play();
            statusDiv.innerText = "âœ… æ’­æ”¾æˆåŠŸ (gTTS)";
            statusDiv.style.color = "green";
            
            player.onended = () => speakBtn.disabled = false;

        } catch (error) {
            console.error(error);
            // æŠŠéŒ¯èª¤é¡¯ç¤ºåœ¨ç•«é¢ä¸Šï¼Œé€™æ‰æ˜¯æˆ‘å€‘éœ€è¦çš„ï¼
            statusDiv.innerText = `âŒ ç™¼ç”ŸéŒ¯èª¤:\n${error.message}`;
            statusDiv.style.color = "red";
            speakBtn.disabled = false;
        }
    }
</script>
</body>
</html>
