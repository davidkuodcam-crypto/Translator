<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS èªéŸ³å¼•æ“å¤§å°æ±º</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            padding: 2rem 1rem;
            line-height: 1.5;
        }
        .container {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        h1 { margin-top: 0; text-align: center; color: var(--primary); }
        .control-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        
        select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        textarea { height: 120px; resize: vertical; }

        .radio-group {
            display: flex;
            gap: 1rem;
            background: #f1f5f9;
            padding: 0.5rem;
            border-radius: 8px;
        }
        .radio-option {
            flex: 1;
            text-align: center;
        }
        .radio-option input { display: none; }
        .radio-option label {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            margin: 0;
            display: block;
            transition: all 0.2s;
            font-weight: normal;
        }
        .radio-option input:checked + label {
            background: var(--primary);
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button {
            width: 100%;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; }

        #status {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
            color: #64748b;
            min-height: 1.5em;
        }
        .note {
            font-size: 0.8rem;
            color: #ef4444;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”Š TTS èªéŸ³å¼•æ“å°æ±º</h1>
    
    <div class="control-group">
        <label>1. é¸æ“‡èªè¨€</label>
        <select id="langSelect">
            <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ (å°ç£)</option>
            <option value="en">ğŸ‡ºğŸ‡¸ è‹±æ–‡ (English)</option>
            <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æ–‡ (æ—¥æœ¬èª)</option>
            <option value="vi">ğŸ‡»ğŸ‡³ è¶Šå—èª (Tiáº¿ng Viá»‡t)</option>
        </select>
    </div>

    <div class="control-group">
        <label>2. é¸æ“‡ç™¼éŸ³å¼•æ“</label>
        <div class="radio-group">
            <div class="radio-option">
                <input type="radio" id="engine-browser" name="engine" value="browser" checked>
                <label for="engine-browser">ç€è¦½å™¨å…§å»º<br><small>(å¿«/æ©Ÿæ¢°éŸ³)</small></label>
            </div>
            <div class="radio-option">
                <input type="radio" id="engine-server" name="engine" value="server">
                <label for="engine-server">Google gTTS<br><small>(æ…¢/è‡ªç„¶éŸ³)</small></label>
            </div>
        </div>
        <div id="browser-warning" class="note" style="display:none">
            âš ï¸ æ³¨æ„ï¼šæ‚¨çš„é›»è…¦å¯èƒ½æ²’æœ‰å®‰è£è¶Šå—èªèªéŸ³åŒ…ï¼Œç€è¦½å™¨æ¨¡å¼å¯èƒ½ç„¡æ³•ç™¼è²ã€‚
        </div>
    </div>

    <div class="control-group">
        <label>3. è¼¸å…¥æ–‡å­—</label>
        <textarea id="textInput" placeholder="è«‹è¼¸å…¥æ‚¨æƒ³æ¸¬è©¦çš„æ–‡å­—...">ä½ å¥½ï¼Œä»Šå¤©å¤©æ°£çœŸä¸éŒ¯ã€‚</textarea>
    </div>

    <button id="speakBtn" onclick="handleSpeak()">é–‹å§‹æœ—è®€</button>
    <div id="status"></div>
    
    <!-- éš±è—çš„æ’­æ”¾å™¨ï¼Œçµ¦ gTTS ç”¨ -->
    <audio id="audioPlayer" style="display:none"></audio>
</div>

<script>
    const synth = window.speechSynthesis;
    const statusDiv = document.getElementById('status');
    const speakBtn = document.getElementById('speakBtn');
    const langSelect = document.getElementById('langSelect');
    const browserWarning = document.getElementById('browser-warning');

    // é è¨­æ–‡å­—åˆ‡æ›
    const defaultTexts = {
        'zh-TW': 'ä½ å¥½ï¼Œä»Šå¤©å¤©æ°£çœŸä¸éŒ¯ï¼Œæˆ‘å€‘ä¾†æ¸¬è©¦èªéŸ³åˆæˆã€‚',
        'en': 'Hello, the weather is nice today. Let us test the speech synthesis.',
        'ja': 'ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã§ã™ã­ã€‚éŸ³å£°åˆæˆã®ãƒ†ã‚¹ãƒˆã‚’ã—ã¾ã—ã‚‡ã†ã€‚',
        'vi': 'Xin chÃ o, hÃ´m nay thá»i tiáº¿t tháº­t Ä‘áº¹p. HÃ£y cÃ¹ng kiá»ƒm tra tá»•ng há»£p giá»ng nÃ³i.'
    };

    langSelect.addEventListener('change', (e) => {
        const lang = e.target.value;
        document.getElementById('textInput').value = defaultTexts[lang];
        
        // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´è©²èªè¨€ (ç°¡å–®æª¢æŸ¥)
        if (lang === 'vi') {
            browserWarning.style.display = 'block';
        } else {
            browserWarning.style.display = 'none';
        }
    });

    async function handleSpeak() {
        const text = document.getElementById('textInput').value;
        const lang = document.getElementById('langSelect').value;
        const engine = document.querySelector('input[name="engine"]:checked').value;

        if (!text) {
            statusDiv.innerText = "è«‹å…ˆè¼¸å…¥æ–‡å­—ï¼";
            return;
        }

        speakBtn.disabled = true;
        statusDiv.innerText = "æº–å‚™ä¸­...";

        if (engine === 'browser') {
            speakWithBrowser(text, lang);
        } else {
            await speakWithServer(text, lang);
        }
    }

    // --- å¼•æ“ 1: ç€è¦½å™¨å…§å»º Web Speech API ---
    function speakWithBrowser(text, lang) {
        // åœæ­¢ä¹‹å‰çš„ç™¼éŸ³
        synth.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        
        // è¨­å®šèªè¨€ä»£ç¢¼ (ç€è¦½å™¨é€šå¸¸éœ€è¦æ¨™æº– BCP 47 tag)
        let browserLang = lang;
        if (lang === 'en') browserLang = 'en-US';
        if (lang === 'ja') browserLang = 'ja-JP';
        if (lang === 'vi') browserLang = 'vi-VN';
        
        utterance.lang = browserLang;
        utterance.rate = 1.0; // èªé€Ÿ

        utterance.onstart = () => { statusDiv.innerText = "ğŸ”Š ç€è¦½å™¨æ­£åœ¨æœ—è®€..."; };
        utterance.onend = () => { 
            statusDiv.innerText = "âœ… æœ—è®€çµæŸ"; 
            speakBtn.disabled = false;
        };
        utterance.onerror = (e) => {
            console.error(e);
            statusDiv.innerText = "âŒ ç€è¦½å™¨ç™¼éŸ³å¤±æ•— (å¯èƒ½ä¸æ”¯æ´æ­¤èªè¨€)";
            speakBtn.disabled = false;
        };

        synth.speak(utterance);
    }

    // --- å¼•æ“ 2: Server ç«¯ gTTS (Vercel Python) ---
    async function speakWithServer(text, lang) {
        statusDiv.innerText = "â³ æ­£åœ¨å‘¼å« Google ç¿»è­¯å¼•æ“ (Vercel)...";
        const player = document.getElementById('audioPlayer');

        try {
            // å‘¼å«å¾Œç«¯ API
            const response = await fetch(`/api/speak?text=${encodeURIComponent(text)}&lang=${lang}`);
            
            if (!response.ok) throw new Error("API è«‹æ±‚å¤±æ•—");

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            
            player.src = url;
            player.style.display = 'block';
            
            statusDiv.innerText = "ğŸ”Š gTTS æ­£åœ¨æ’­æ”¾...";
            await player.play();
            
            player.onended = () => {
                statusDiv.innerText = "âœ… æ’­æ”¾çµæŸ";
                speakBtn.disabled = false;
            };

        } catch (error) {
            console.error(error);
            statusDiv.innerText = "âŒ ä¼ºæœå™¨éŒ¯èª¤ (å¯èƒ½æ˜¯ Vercel é€£ç·šé€¾æ™‚)";
            speakBtn.disabled = false;
        }
    }
</script>

</body>
</html>